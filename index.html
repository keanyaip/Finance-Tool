<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F-Hub: Monthly Finance Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-active { border-bottom: 4px solid #1e3a8a; color: #1e3a8a; font-weight: bold; }
        .hidden { display: none; }
        .monitor-grid { display: grid; grid-template-columns: 180px repeat(4, 1fr); gap: 1px; background-color: #e2e8f0; border: 1px solid #e2e8f0; }
        .monitor-cell { background-color: white; padding: 12px; font-size: 13px; display: flex; align-items: center; justify-content: center; text-align: center; }
        .monitor-header { background-color: #f8fafc; font-weight: bold; color: #475569; text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; }
        .acc-tag { background-color: #fef08a; font-weight: bold; justify-content: space-between !important; padding: 10px 15px; }
        .bg-income { background-color: #e0f2fe; }
        .bg-expense { background-color: #ffe4e6; }
        input:focus { outline: none; border-bottom: 1px solid #2563eb; }
        .filtered-out { display: none !important; }
        .font-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        
        /* New Styles for Sorting */
        .sort-header { cursor: pointer; position: relative; transition: background 0.2s; }
        .sort-header:hover { background-color: #f1f5f9; }
        .sort-header::after { content: ' ↕'; font-size: 10px; opacity: 0.4; margin-left: 4px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen pb-20">

    <nav class="bg-white shadow-sm border-b sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
            <div class="flex overflow-x-auto">
                <button onclick="showTab('balance-sheet')" id="tab-bs" class="py-4 px-6 text-xs uppercase">Asset & Liability</button>
                <button onclick="showTab('income-statement')" id="tab-is" class="py-4 px-6 text-xs uppercase">Income Statement</button>
                <button onclick="showTab('cash-flow')" id="tab-cf" class="py-4 px-6 text-xs uppercase">Cash Flow Monitoring</button>
                <button onclick="showTab('ledger')" id="tab-lg" class="py-4 px-6 text-xs uppercase">Ledger</button>
            </div>
            <div class="flex gap-2">
                <button onclick="saveToBrowser()" class="bg-emerald-600 text-white px-4 py-2 rounded text-[10px] font-bold shadow-sm hover:bg-emerald-700">SAVE DATA</button>
                <button onclick="clearStorage()" class="bg-slate-200 text-slate-600 px-4 py-2 rounded text-[10px] font-bold hover:bg-rose-500 hover:text-white transition">RESET</button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-4 md:p-8">

        <div class="bg-white p-5 mb-6 rounded-xl shadow border flex justify-between items-center">
            <div>
                <h2 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Active Period</h2>
                <select id="global-month-selector" onchange="sync()" class="text-xl font-bold text-blue-900 bg-transparent outline-none cursor-pointer border-b-2 border-blue-100 hover:border-blue-500">
                    <option value="">No Data</option>
                </select>
            </div>
            <div class="text-right">
                <span class="text-[10px] text-slate-400 uppercase block tracking-widest mb-1">Status</span>
                <span class="text-xs font-bold text-emerald-600 flex items-center gap-1 justify-end">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span> LIVE DATA
                </span>
            </div>
        </div>

        <div id="balance-sheet" class="hidden space-y-6">
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow border">
                    <h2 class="font-bold text-emerald-700 mb-4 uppercase text-sm border-b pb-2">Assets</h2>
                    <div id="bs-assets-container" class="space-y-3"></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow border">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="font-bold text-rose-700 uppercase text-sm">Liability (Manual Entry)</h2>
                        <button onclick="addManualLiability()" class="bg-rose-50 text-rose-600 px-3 py-1 rounded text-[10px] font-bold border border-rose-200 hover:bg-rose-100">+ ADD NEW</button>
                    </div>
                    <div id="bs-liab-container" class="space-y-3"></div>
                </div>
            </div>
            <div class="bg-slate-900 text-white p-6 rounded-xl flex justify-between items-center shadow-lg">
                <span class="font-bold uppercase text-xs tracking-widest text-slate-400">Net Equity</span>
                <span class="text-2xl font-mono font-bold">RM <span id="equity-display">0.00</span></span>
            </div>
        </div>

        <div id="cash-flow" class="space-y-6">
            <div class="bg-white p-5 rounded-xl shadow border flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="text-lg font-bold">Cash Flow Monitoring</h2>
                <div class="flex gap-2">
                    <select id="acc-picker" class="border rounded-lg px-4 py-2 bg-slate-50 text-sm outline-none font-bold text-blue-600">
                        <option value="">-- Select Account --</option>
                    </select>
                    <button onclick="monitorNew()" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-xs font-bold hover:bg-blue-700">MONITOR ACCOUNT</button>
                </div>
            </div>
            <div id="monitoring-container" class="bg-white rounded-xl shadow border overflow-hidden"></div>
        </div>

        <div id="income-statement" class="hidden space-y-6">
            <div class="bg-white rounded-xl shadow border overflow-hidden">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-slate-100 border-b">
                            <th class="p-4 text-left">Category</th>
                            <th class="p-4 text-right">Amount (RM)</th>
                            <th class="p-4 text-right text-xs">%</th>
                        </tr>
                    </thead>
                    <tbody id="is-tbody"></tbody>
                    <tfoot class="bg-slate-800 text-white font-bold">
                        <tr>
                            <td class="p-4">NET INCOME</td>
                            <td class="p-4 text-right" id="is-net-total">0.00</td>
                            <td class="p-4 text-right text-yellow-400" id="is-net-pct">0%</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="ledger" class="hidden space-y-4">
            <div class="flex justify-between items-center gap-4">
                <input type="text" id="ledger-search-input" onkeyup="applyLedgerSearch()" placeholder="Search Ledger..." class="border rounded-lg px-4 py-2 text-sm w-full md:w-80 shadow-sm">
                <button onclick="addRow()" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-xs font-bold shadow-lg">+ NEW ENTRY</button>
            </div>
            <div class="bg-white rounded-xl shadow border overflow-x-auto">
                <table class="w-full text-[12px] min-w-[900px]">
                    <thead class="bg-slate-50 text-slate-500 font-bold border-b">
                        <tr>
                            <th onclick="sortTable(0)" class="p-4 text-left sort-header">Date</th>
                            <th onclick="sortTable(1)" class="p-4 text-left sort-header">Type</th>
                            <th onclick="sortTable(2)" class="p-4 text-left sort-header">From</th>
                            <th onclick="sortTable(3)" class="p-4 text-left sort-header">To</th>
                            <th onclick="sortTable(4)" class="p-4 text-right sort-header">Amount</th>
                            <th class="p-4 text-left">Remark</th>
                            <th class="p-3"></th>
                        </tr>
                    </thead>
                    <tbody id="ledger-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let monitoringList = {}; 
        let manualLiabs = {}; 
        let currentSortDir = true; // true = asc, false = desc

        function fmt(num) { return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

        function addRow(data = null) {
            const tr = document.createElement('tr');
            tr.className = "ledger-row border-b hover:bg-slate-50";
            tr.innerHTML = `
                <td class="p-3"><input type="date" class="w-full bg-transparent t-date" value="${data ? data.date : ''}" onchange="sync()"></td>
                <td class="p-3"><select onchange="sync()" class="t-type bg-transparent font-bold text-blue-600 outline-none">
                    <option value="transfer" ${data?.type==='transfer'?'selected':''}>Transfer</option>
                    <option value="income" ${data?.type==='income'?'selected':''}>Income</option>
                    <option value="indirect" ${data?.type==='indirect'?'selected':''}>Interest</option>
                    <option value="expenses" ${data?.type==='expenses'?'selected':''}>Expenses</option>
                </select></td>
                <td class="p-3"><input type="text" oninput="sync()" class="t-from w-full bg-transparent uppercase" value="${data ? data.from : ''}"></td>
                <td class="p-3"><input type="text" oninput="sync()" class="t-to w-full bg-transparent uppercase" value="${data ? data.to : ''}"></td>
                <td class="p-3"><input type="number" step="0.01" oninput="sync()" class="t-amt w-full bg-transparent text-right" value="${data ? data.amt : ''}"></td>
                <td class="p-3"><input type="text" oninput="sync()" class="t-rem w-full bg-transparent" value="${data ? data.rem : ''}"></td>
                <td class="p-3 text-center"><button onclick="confirmDelete(this)" class="text-slate-300 hover:text-red-500">&times;</button></td>
            `;
            document.getElementById('ledger-body').appendChild(tr);
            if(!data) sync();
        }

        /* NEW: Sorting Function for Ledger */
        function sortTable(columnIndex) {
            const tbody = document.getElementById("ledger-body");
            const rows = Array.from(tbody.rows);
            
            rows.sort((a, b) => {
                let valA, valB;
                
                // Fetch values based on column (inputs or selects)
                if (columnIndex === 1) { // Select box for Type
                    valA = a.cells[columnIndex].querySelector('select').value.toLowerCase();
                    valB = b.cells[columnIndex].querySelector('select').value.toLowerCase();
                } else { // Inputs for Date, From, To, Amount
                    valA = a.cells[columnIndex].querySelector('input').value.toLowerCase();
                    valB = b.cells[columnIndex].querySelector('input').value.toLowerCase();
                }

                // If sorting by Amount, convert to float
                if (columnIndex === 4) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                }

                if (valA < valB) return currentSortDir ? -1 : 1;
                if (valA > valB) return currentSortDir ? 1 : -1;
                return 0;
            });

            currentSortDir = !currentSortDir; // Toggle direction
            rows.forEach(row => tbody.appendChild(row));
        }

        function confirmDelete(btn) { if (confirm("Delete row?")) { btn.closest('tr').remove(); sync(); } }

        function applyLedgerSearch() {
            const query = document.getElementById('ledger-search-input').value.toLowerCase();
            document.querySelectorAll('#ledger-body tr').forEach(row => {
                const text = Array.from(row.querySelectorAll('input, select')).map(i => i.value.toLowerCase()).join(' ');
                row.classList.toggle('filtered-out', !text.includes(query));
            });
        }

        function addManualLiability() {
            const name = prompt("Enter Liability Name (e.g., Credit Card, Car Loan):");
            if (name) {
                const amount = parseFloat(prompt(`Enter outstanding balance for ${name}:`, "0")) || 0;
                manualLiabs[name] = amount;
                sync();
            }
        }

        function removeLiability(name) {
            if (confirm(`Remove ${name}?`)) {
                delete manualLiabs[name];
                sync();
            }
        }

        function sync() {
            const rows = document.querySelectorAll('#ledger-body tr');
            let foundNames = new Set();
            let monthsSet = new Set();
            let allLedgerData = [];

            rows.forEach(r => {
                const dateVal = r.querySelector('.t-date').value;
                if(dateVal) monthsSet.add(dateVal.substring(0, 7));
                const f = r.querySelector('.t-from').value.trim().toUpperCase();
                const t = r.querySelector('.t-to').value.trim().toUpperCase();
                const amt = parseFloat(r.querySelector('.t-amt').value) || 0;
                if(f) foundNames.add(f); if(t) foundNames.add(t);
                allLedgerData.push({ date: dateVal, monthKey: dateVal ? dateVal.substring(0, 7) : null, type: r.querySelector('.t-type').value, from: f, to: t, amt, rem: r.querySelector('.t-rem').value.trim() });
            });

            const mSelect = document.getElementById('global-month-selector');
            const prevSelected = mSelect.value;
            const sortedMonths = Array.from(monthsSet).sort();
            
            if(sortedMonths.length > 0) {
                mSelect.innerHTML = '';
                sortedMonths.slice().reverse().forEach(m => {
                    const label = new Date(m + "-01").toLocaleString('default', { month: 'long', year: 'numeric' });
                    mSelect.add(new Option(label, m, false, m === prevSelected));
                });
                if(!mSelect.value) mSelect.value = sortedMonths[sortedMonths.length-1];
            }

            const picker = document.getElementById('acc-picker');
            picker.innerHTML = '<option value="">-- Choose Account --</option>';
            Array.from(foundNames).sort().forEach(n => picker.innerHTML += `<option value="${n}">${n}</option>`);

            updateCalculations(allLedgerData, mSelect.value, sortedMonths);
        }

        function updateCalculations(allData, selectedMonth, sortedMonths) {
            if(!selectedMonth) return;
            const filterData = allData.filter(d => d.monthKey === selectedMonth);
            
            let workRev = 0, bankInt = 0, totalExp = 0;
            filterData.forEach(d => {
                if(d.type === 'income') workRev += d.amt;
                else if(d.type === 'indirect') bankInt += d.amt;
                else if(d.type === 'expenses') { totalExp += d.amt; }
            });
            const totalInc = workRev + bankInt;
            document.getElementById('is-tbody').innerHTML = `<tr class="bg-income border-b"><td>Revenue</td><td class="text-right">${fmt(workRev)}</td><td class="text-right">100%</td></tr>`;
            document.getElementById('is-net-total').innerText = fmt(totalInc - totalExp);

            const assetsCon = document.getElementById('bs-assets-container');
            assetsCon.innerHTML = '';
            let totalAssets = 0;
            let cfHtml = `<div class="monitor-grid"><div class="monitor-cell monitor-header">Account</div><div class="monitor-cell monitor-header">Opening</div><div class="monitor-cell monitor-header text-emerald-600">In (+)</div><div class="monitor-cell monitor-header text-rose-500">Out (-)</div><div class="monitor-cell monitor-header">Closing</div>`;

            const currentMonthList = monitoringList[selectedMonth] || {};
            for (let acc in currentMonthList) {
                let opening = 0;
                const mIdx = sortedMonths.indexOf(selectedMonth);
                if (mIdx > 0) {
                    let hIn = 0, hOut = 0;
                    let startM = sortedMonths.find(m => monitoringList[m] && monitoringList[m][acc] !== undefined);
                    let startB = monitoringList[startM][acc];
                    allData.forEach(d => { if(d.monthKey < selectedMonth) { if(d.to === acc) hIn += d.amt; if(d.from === acc) hOut += d.amt; } });
                    opening = startB + hIn - hOut;
                } else { opening = currentMonthList[acc]; }

                let mIn = 0, mOut = 0;
                filterData.forEach(d => { if(d.to === acc) mIn += d.amt; if(d.from === acc) mOut += d.amt; });
                const closing = opening + mIn - mOut;
                totalAssets += closing;
                cfHtml += `<div class="monitor-cell acc-tag">${acc} <button onclick="stopMonitoring('${acc}')" class="text-rose-400">×</button></div><div class="monitor-cell">${fmt(opening)}</div><div class="monitor-cell text-emerald-600">${fmt(mIn)}</div><div class="monitor-cell text-rose-500">${fmt(mOut)}</div><div class="monitor-cell font-bold">${fmt(closing)}</div>`;
                assetsCon.innerHTML += `<div class="flex justify-between p-3 bg-slate-50 rounded border"><span>${acc}</span><span class="font-bold text-emerald-700">${fmt(closing)}</span></div>`;
            }
            document.getElementById('monitoring-container').innerHTML = cfHtml + '</div>';

            const liabCon = document.getElementById('bs-liab-container');
            liabCon.innerHTML = '';
            let totalLiabs = 0;
            for(let l in manualLiabs) {
                totalLiabs += manualLiabs[l];
                liabCon.innerHTML += `<div class="flex justify-between p-3 bg-rose-50 rounded border border-rose-100">
                    <span>${l} <button onclick="removeLiability('${l}')" class="text-rose-300 ml-2 hover:text-rose-600">×</button></span>
                    <span class="font-bold text-rose-700">${fmt(manualLiabs[l])}</span>
                </div>`;
            }
            document.getElementById('equity-display').innerText = fmt(totalAssets - totalLiabs);
        }

        function monitorNew() {
            const m = document.getElementById('global-month-selector').value;
            const n = document.getElementById('acc-picker').value;
            if(!m || !n) return alert("Select month and account first.");
            if(!monitoringList[m]) monitoringList[m] = {};
            monitoringList[m][n] = parseFloat(prompt(`Starting balance for ${n}:`, "0")) || 0;
            sync();
        }

        function stopMonitoring(acc) {
            const m = document.getElementById('global-month-selector').value;
            delete monitoringList[m][acc];
            sync();
        }

        function showTab(id) {
            ['balance-sheet', 'income-statement', 'cash-flow', 'ledger'].forEach(t => document.getElementById(t).classList.toggle('hidden', t !== id));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active', 'text-blue-700'));
            const btnMap = {'balance-sheet':'tab-bs','income-statement':'tab-is','cash-flow':'tab-cf','ledger':'tab-lg'};
            document.getElementById(btnMap[id]).classList.add('tab-active', 'text-blue-700');
        }

        function saveToBrowser() {
            const ledgerRows = [];
            document.querySelectorAll('#ledger-body tr').forEach(r => {
                ledgerRows.push({ date: r.querySelector('.t-date').value, type: r.querySelector('.t-type').value, from: r.querySelector('.t-from').value, to: r.querySelector('.t-to').value, amt: r.querySelector('.t-amt').value, rem: r.querySelector('.t-rem').value });
            });
            localStorage.setItem('financeData_v4', JSON.stringify({ ledgerRows, monitoringList, manualLiabs }));
            alert("Data Saved!");
        }

        function loadFromBrowser() {
            const saved = localStorage.getItem('financeData_v4');
            if(saved) {
                const d = JSON.parse(saved);
                monitoringList = d.monitoringList || {};
                manualLiabs = d.manualLiabs || {};
                document.getElementById('ledger-body').innerHTML = '';
                if(d.ledgerRows.length) d.ledgerRows.forEach(r => addRow(r)); else addRow();
            } else { addRow(); }
            sync();
        }

        function clearStorage() { if(confirm("Reset all data?")) { localStorage.clear(); location.reload(); } }
        window.onload = loadFromBrowser;
    </script>
</body>
</html>